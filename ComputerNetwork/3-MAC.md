

### 五、从物理层到MAC层：如何在宿舍里自己组网玩联机游戏
机器有了 IP 之后就可以在网络的环境里和其他机器展开沟通了


第一层：物理层
电脑连电脑，网线水晶头要做交叉线，1-3、2-6交叉接法。
水晶头的第1、2和3、6脚，起着收发信号的作用，交换位置能够在物理层实现一端发送的信号，另一端能收到。
另外还需要配置这两台电脑的 IP 地址、子网掩码和默认网关。
然后两台电脑已经构成了一个最小的局域网，LAN
三个电脑连在一起，有个 Hub 集线器，和交换机不同，没有大脑完全在物理层工作，将自己收到的每个字节，都复制到其他端口上。

第二层：数据链路层（MAC层 Medium Access Control 媒体访问控制）
Hub 发包，MAC层控制在往媒体上发数据的时候，谁先发、谁后发的问题，防止发生混乱。这个问题中的规则，学名叫多路访问：
解决方式：
方式一：多车道。信道划分；
方式二：单双号限行，轮着来。轮流协议；
方式三：先出门堵了就回去，不堵再出去。随机接入协议；

发给谁，谁接收？
需要用到物理地址，链路层地址，常被称为MAC地址。解决这个问题牵扯到第二层的网络包格式。
目标MAC(6byte) 源MAC(6byte) 类型(2byte) 数据(46-1500byte) CRC(4byte)
类型：大部分类型是 IP 数据包，然后IP里包含TCP、UDP，以及HTTP，都是里层封装的。
有了目标MAC地址，数据包在链路上广播，MAC的网卡才能发现这个包是它的，网卡把包收进来，然后打开IP包，发现IP地址也是自己的，再打开TCP包，发现端口是自己80，而nginx就是监听80。于是将请求交给ngix，返回一个网页，在层层封装返回给请求的机器。

出错了怎么办？
对于以太网，第二层的最后面CRC循环冗余检测，通过 XOR 异或算法，来计算整个包是否在发送的过程中出现了错误。

ARP协议，已知IP地址，求MAC地址的协议。
发送一个广播包，谁是这个IP谁来回答。为了避免每次都ARP请求，本地机器会进行ARP缓存，机器会不断地上线下线，IP地址也可能会变，所以ARP的MAC地址缓存过一段时间就会过期。


局域网
Hub是广播的，不管某个接口是否需要，所有的Bit都会被发送出去，让主机来判断是不是需要，网络包一多就会冲突。
智能一点的需要一个能把MAC头拿下来，检查一下目标MAC地址，然后根据策略转发的设备：交换机。
这需要交换机具有学习能力：一台MAC1电脑要把包发给MAC2电脑，交换机刚开始也不知，只能发给所有的口，交换机会记住MAC1是来自一个明确的口，记下来，下次发给MAC1直接发送到那个口就行了。就这样过了一段时间，就有了整个网络的结构了，基本不用广播，可以准确转发。当然机器的IP地址会变，所在的口也会变，交换机的学习的结果，转发表有过期时间。


小结：
1、MAC层是用来解决多路访问的堵车问题的；
2、ARP通过吼的方式寻找MAC地址，吼完记住一段时间，这个叫缓存；
3、交换机是有MAC地址学习能力的；

有个RARP协议，是已知MAC求IP的，用来干嘛？
局域网里有多个交换机，ARP广播的模式会出现什么问题？多个可能会形成一个回路，不停转发，占满宽带，或者是解析协议的硬件过载，形成广播风暴。





### 六、交换机与VLAN
拓扑结构
办公室上百台机器，多台交换机，交换机连接起来形成一个稍微复杂的拓扑结构。

环路问题
当拓扑结构复杂了，不可避免的会出现一些意料不到的情况，常见的的问题就是环路问题。


STP协议
在数据结构中，有一个方法叫作最小生成树，有环的我们常称为图，将图破坏了，就生成了树。在计算机网络中，生成树的算法叫作STP，全称Spanning Tree Protocol
1、Root Bridge  根交换机，掌门机
2、Designated Bridges 指定交换机。树枝，通过它到达根交换机
3、Bridge Protocol Data Units (BPDU) 网桥协议数据单元
4、Priority Vector 优先级向量。实力距离根的距离 值越小越牛
刚开始，都不清楚情况，每个网桥都被分配了一个ID，ID里有管理员分配的优先级。
然后开始发送 BPDU ，相邻的两两比较出优先级高低，在继续发然后合并比较优先级，优化路线


如何解决广播问题和安全问题？
安全问题：
一个是物理隔离，每个部门设一个单独的会议室，每个部门有单独的交换机，配置单独的子网。
另一个是虚拟隔离，VLAN，或者叫虚拟局域网。使用VLAN 一个交换机上回连属于多个局域网的机器。为了区分哪个机器属于哪个局域网，需要在原来的二层的头上加一个 TAG，里面有 VLAN ID，一共12位，12位可以划分4096个VLAN。
二层头：目标MAC  源MAC  8021Q-TAG  类型  数据
TAG：类型  优先级  规范格式  VLAN-ID(12位)

交换机支持VLAN，把二层的头取下来就能识别这个VLAN ID，这样只有相同 VLAN 包，才会互相转发，不同 VLAN 的包，是看不到的，安全问题得以解决。
对于交换机来讲，每个 VLAN 的口都是可以重新设置的。
对于支持VLAN的交换机，有一种口叫作Trunk口，可以转发属于任何VLAN的口，交换机之间可以通过这种口互相连接。

小结：
1、当交换机数量越来越多的时候，会遇到环路，需要使用STP协议，将有环路的图变成没有环路的树，从而解决环路问题。
2、交换机数目多会面临隔离问题，可以通过VLAN形成虚拟局域网，从而解决广播和安全问题。
问题：
STP的缺点。在大的网络中两个机器不同，怎么调试。

