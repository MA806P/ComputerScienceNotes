 

### 三、ifconfig:最熟悉又陌生的命令行
怎样查看 IP 地址？
Windows 上 ipconfig
Linux 上是 ifconfig 和 ip addr

IP地址是网卡在网络世界的通讯地址。
32位 IP 地址，分为 5 类，A、B、C类主要分为两部分，前一部分网络号，后一部分主机号。
前几位ABCDE类地址
0
10
110
1110
11110
  	IP地址范围  		最大主机数  	私有IP地址范围
A 0.0.0.0--127.255.255.255    16777214	  10.0.0.0--10.255.255.255
B 128.0.0.0--191.255.255.255  65534  	  172.16.0.0--172.31.255.255
C 192.0.0.0--223.255.255.255  254	  192.168.0.0--192.168.255.255

无类型域间选路（CIDR）
将 32 位的 IP 地址一分为二，前面是网络号，后面是主机号。10.100.122.2/24，24的意思是，32位中，前24位是网络号，后8位是主机号。
伴随着CIDR存在的，一个是广播地址，10.100.122.255，如果发送这个地址，所有的10.100.122的网络里面的机器都可以收到。另一个是子网掩码，255.255.255.0。
将子网掩码和IP地址&运算，前三个数不变，第四个数为0，10.10.122.0这个就是网络号。
#### 将子网掩码和IP地址&计算就可得到网络号


公有IP地址和私有IP地址
私有IP地址，允许组织内部的IT人员自己管理、自己分配，而且可以重复。
公有IP地址，有组织统一分配，外部的人才能访问。
家里有WiFi，对应就会有有一个IP地址，一般家里上网设备不会超过256个，所以/24基本就够了，常见的还有/16的CIDR，8的倍数很明显容易理解。
如WiFi路由器地址为192.168.0.1，而192.168.0.255就是广播地址，一旦发送这个地址，整个192.1168.0网络里面的所有机器都能收到。


五类地址中的D类是组播地址，使用这个类地址，属于某个组的机器都能收到


root@test:~# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff
    inet 10.100.122.2/24 brd 10.100.122.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fec7:7975/64 scope link 
       valid_lft forever preferred_lft forever

对于网卡 eth0 来说是 global，说明这个网卡是可以对外的，可以接收来自各个地方的包。
lo 是host，说明这个网卡仅仅可以供本机互相通信。全称 loopback 回环接口，往往会被分配到 127.0.0.1 这个地址，用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。



MAC地址
link/ether 。。这个被称为MAC地址，一个网卡的物理地址，十六进制6个字节表示。
一个网络包要从一个地方传到另一个地方除了要有确定的地址，还需要有定位功能，而有门牌号属性的IP地址，才是有远程定位功能的。
MAC地址更像是身份证，是一个唯一的标识，是为了组网的时候，不同网卡放在一个网络里面的时候，可以不用担心冲突。从硬件角度，保证不同的网卡有不同标识。
MAC地址有一定的定位功能，但是通信范围比较小，局限在一个子网里。


网络设备的状态标识 net_device flags: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500
UP 标识网卡处于启动的状态； BROADCAST 表示这个网卡有广播地址，可以发送广播包；
MULTICAST 表示网卡可以发送多播包；LOWER_UP 表示L1是启动的，也即有网线插着。
mtu 1500：最大传输单元MUT为1500，这是以太网的默认值；
MTU 是二层MAC层的概念，规定连MAC头带正文合起来不允许超过1500个字节，正文里有IP头 TCP头 HTTP头，如果放不下就需要分片来传输；
qdisc 全称是queueing discipline 排队规则，最简单的是pfifo不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。pfifo_fast复杂一些队列包括三个波段band，每个波段使用先进先出规则，波段的优先级也不相同。
数据包按照服务类型Type of Service，TOS 被分配到三个波段里面。TOS是IP头里面的一个字段，代表了当前的包是高优先级还是低优先级的。


小结：
IP是地址有定位功能；MAC是身份证无定位功能；
CIDR可以用来判断是不是本地人；
IP分公有和私有；





### 四、DHCP 与 PXE：IP怎么来的、怎么没的

如何配置 IP 地址：
使用 net-tools
ifconfig eth1 10.0.0.1/24
ifconfig eth1 up
使用 iproute2
ip addr add 10.0.0.1/24 dev eth1
ip link set up eth1

如果随便配置一个 IP 地址，会导致包发布出去。192.168.1.6就在你这台机器的旁边，你把机器的IP设置为16.158.23.6，网络包有源IP地址和目标IP地址，但是包发布出去，因为MAC层还没填，目标MAC地址不知道，只有是一个网段的，才会发送ARP请求，获取MAC地址，Linux默认的逻辑是，如果这是一个跨网段的调用，他便不会直接将包发送到网络上，而是企图将包发送到网关。
如果配置了网关Linux会获取网关的MAC地址，然后将包发出去，虽然目标IP地址就在它旁边，但是目标MAC地址不是所以网卡不会把包收进去。
如果没有配置网关，那包根本就发不出去
真正配置IP时，不是直接用命令配置的，而是放在一个配置文件里。不同系统的配置文件格式不同，但无非就是 CIDR、子网掩码、广播地址和网关地址。


动态主机配置协议（DHCP）Dynamic Host Configuration Protocol
只需要配置一段共享的IP地址，每台新接入的机器通过DHCP协议，来这个共享的IP地址里申请，然后自动配置好就可以，用完了还回去，其他机器也能用。
DHCP工作方式：
1>当机器加入一个网络时只知道自己的MAC地址，这时沟通基本靠吼，这阶段成为 DHCP Discover。
2>使用IP地址0.0.0.0发送一个广播包，目的IP地址为255.255.255.255，广播包封装了UDP，UDP封装了BOOTP，其实DHCP是BOOTP的增强版，当网络管理员在网络里面配置了 DHCP Server的话，网络就通过唯一的MAC地址就会知道来个新机器，就会租给它一个IP地址，这个过程成为 DHCP Offer。
3>DHCP Server响应包仍然使用广播地址作为目的地址，因为新机器还没有IP地址，新机器收到回复包得到IP地址，可能会收到多个响应包，会选择其中一个DHCP Offer一般是最先到达的那个，并且会向网络发送一个DHCP Request广播数据包，包中有新机器的MAC地址、接受租约中的IP地址、提供此租约的DHCP服务器地址等，告诉所有DHCP Server 它接受了那个服务器提供的IP，告诉其它服务器分配的IP没用上，撤销提供的IP供其它机器用。
4>当DHCP Server接收到新机器的 DHCP Request 之后，会广播返回给新机器一个 DHCP ACK消息包，表明已经接受新机器的选择。
5>最终的租约达成的时候，还是需要广播一下，让大家都知道。



IP地址的收回和续租
客户机在租期过去50%的时候，直接向为其提供IP地址的 DHCP Server 发送 DHCP Request 消息包，客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及更新的TCP/IP参数，更新自己的配置，这样 IP 租用更新就完成了。


预启动执行环境 PXE（Pre-boot Execution Environment）
网络管理员不仅能自动分配 IP 地址，还能帮你自动安装操作系统。在数据中心很多机器使用。
类似操作系统启动，首先启动BIOS，这是个特别小的系统，只能干特别小的一件事。其实就是读取硬盘的 MBR 启动扇区，将 GRUB 启动起来，然后将全力交给 GRUB 加载内核、加载作为根文件系统的 initramfs 文件；然后将权力交给内核；最后内核启动，初始化整个操作系统。安装OS 只能插在 BIOS 启动之后，安装OS之前，连启动扇区都没有，因而整个过程叫做预启动执行环境。

PXE 协议分为客户端和服务器端，还没有OS只能先把客户端放在BIOS里面，当计算机启动时，BIOS把PXE客户端调入内存里，就可以连接到服务端做操作。
首先，PXE客户端自己也需要有个IP地址，客户端启动就可以发送一个DHCP的请求，有了自己的IP地址，知道PXE服务器在哪，也可以知道如何从PXE服务器上下载某个文件，去初始化操作系统。


小结：
DHCP 协议主要是用来给客户租用 IP 地址，和房产中介很像，要商谈、签约、续租，广播还不能“抢单”；
DHCP 协议能给客户推荐“装修队”PXE，能够安装操作系统，这个在云计算领域大有用处；










