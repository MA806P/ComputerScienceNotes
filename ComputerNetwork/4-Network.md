

### 七、ICMP 与 ping

ICMP 协议的格式：
ping 是基于 ICMP 协议工作的，Internet Control Message Protocol，互联网控制报文协议。
ICMP 报文是封装在 IP 包里，传输命令的时候，肯定需要源地址和目标地址，本身非常简单，作为侦察兵就要轻装上阵。
IP头  ICMP报文
ICMP报文：类型8位 代码8位 校验16位 数据(请求与相应:标识符16位 序号16位 数据。差错报文:unused16位 unused16位 IP头 8Byte正文)
ICMP报文有很多的类型，不同类型有不同的代码。最常用的类型是主动请求为8，主动请求的应答为0.

查询报文类型：
主动发起的对应 ICMP 的查询报文类型。常用的 ping 就是查询报文，是一种主动请求，并且获得主动应答的 ICMP 协议。ping 的主动请求称为 ICMP ECHO REQUEST。主动请求的回复称为 ICMP ECHO REPLY。比起原生的 ICMP，里面多了两个字段，一个是标识符，另一个是序号。在选项数据中 ping 还会存放发送请求的时间值，来计算往返时间

差错报文类型：
1、终点不可达 3
网络不可达代码为0，主机不可达为1，协议不可达为2，端口不可达为3，需要进行分片但设置了不分片为4
2、源抑制 4，就是让源站放慢发送速度
3、超时 11，超过网络包的生存时间还是没到
4、路由重定向 5，让下次发给另一个路由
差错报文的结构相对复杂一些，除了前面还是 IP，ICMP 的前8字节不变，后面则跟上出错的那个IP包的IP头和IP正文的前8个字节。

ping：查询报文类型的使用
![ping](https://github.com/MA806P/ComputerScienceNotes/blob/master/ComputerNetwork/Images/4-Network-Ping.jpg)
在规定的时间内，源主机没有接到 ICMP 的应打包，说明主机不可达；如果收到应答包，说明可达，源主机会检测，计算出 ICMP 数据包的时间延迟。
如在自己的可控范围之内，遇到网络不通的问题，除了直接ping目标的IP地址外，还应有一个清晰得网络拓扑图，要知道经过哪些设备，然后逐个ping中间的这些设备或机器。如果可能的话在这些关键点，通过 tcpdump -i eth0 icmp, 查看包有没有到达某个点，回复的包到达哪一个点，可以更加容易推断出错的位置。


Traceroute：差错报文类型的使用
Traceroute，是个“大骗子”。它会使用 ICMP 的规则，故意制造一些能够产生错误的场景。
所以第一个作用就是故意设置特殊的 TTL(Time To Live 生存时间)，来追踪去往目的地时沿途经过的路由器。向目的IP地址发送UDP数据包故意产生错误，数据报到达时目的主机产生错误ICMP报文，返回包从而获取到信息。
Traceroute 还有一个作用是故意设置不分片，从而确定路径的 MTU(Maximum Transmission Unit 最大传输单元。它是指一种通信协议的某一层上面所能通过的最大数据包大小,以字节为单位)，首先发送分组，设置不分片的标志，如果遇到窄的关口会被卡主，会发生ICMP网络差错包，收到ICMP不能分片差错时就减小分组的长度，直到到达目标主机。

小结：
1、ICMP相当于网络世界的侦察兵。两种类型的ICMP报文，主动侦查的查询报文，异常报告的差错报文
2、ping使用查询报文，Traceroute使用差错报文。
如果ICMP的差错报文也出问题了怎办。跨路由、跨网关的过程是怎么ping的。




### 八、出网关
怎么上网：
给每宿舍分配一个 IP 地址，这是校园网的 IP，宿舍网 IP 192.168.1.x，校园网的 IP 地址 10.10.x.x
多个电脑联网，需要配置网卡，DHCP可以默认配置的，除了配置 IP 地址，还需要配置 Gateway 网关

MAC头和IP头：
配置了IP地址和网关，就能够指定目标地址进行访问，跨网关牵扯到MAC地址和IP地址的变化
> MAC头(目的MAC地址48位 源MAC地址48位 协议类型16位-说明里面是IP协议) 
> IP头(版本4位 首部长度4位 服务类型TOS8位 总长度16位 标识16位 标志3位 片偏移13位 TTL8位 协议8位-tcp/udp 首部校验和16位 源IP地址32位 目标IP地址32位 选项)
> 数据

先判断目标IP地址和当前机器IP地址是否在同一个网段，需要CIDR和子网掩码
如果是同一网段，那就没网关什么事了，直接将源地址和目标地址放入IP头中，然后通过ARP获得MAC地址，将源MAC和目的MAC放入MAC头中，发出去就可以了
如果不是同一网段，需要发往默认网关 Gateway 它的地址和源IP地址一定是一个网段的，192.168.1/24。
将源、目标IP地址放入IP头中，通过ARP获得网关的MAC地址，将源MAC和网关的MAC放入MAC头中，发出去。网关收到包进行处理。

网关往往是一个路由器，是一个三层转发的设备。就是把MAC头和IP头都取下来，根据里面的内容，进行转发包。
路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的 IP 地址都和局域网的 IP 地址相同的网段，每只手都是它握住的那个局域网的网关。任何想发往其他局域网的包，都会到达其中一只手，拿进来取下MAC头和IP头，根据自己的路由算法，选择另一只手加上IP头和MAC头，扔出去。
选择那只手，头部要修改那些内容，问题复杂可分为两类，一是静态路由、一是动态路由

静态路由：
其实就是在路由器上，配置一条条规则。每当要选择从哪只手抛出去的时候，就一条一条的匹配规则，找到符合的规则，就按规则中设置的那样，从某个口抛出去，找下一跳 IPX

经过网关，MAC地址就必定会改变，因为已经换了局域网。
不改变 IP 地址的网关，称为转发网关；改变 IP 地址的网关，称为NAT Network Address Translation网关。
改变IP地址情况，从一个局域网发送到另一个局域网，就像出国，不能用咱们自己的身份证，而要改用护照一样。

每家都有家用路由器，家里的网段都是 192.168.1.x，所以你肯定访问不了你邻居家的这个私网的 IP 地址的。所以，当我们家里的包发出去的时候，都被家用路由器 NAT 成为了运营商的地址了。https://www.whatismyip.com/


小结：
1、离开本局域网，就需要经过网关，网关是路由器的一个网口
2、路由器是一个三层设备，里面有如何寻找下一跳的规则
3、经过路由器MAC要变，IP不变、IP要变



### 九、路由协议
如何配置路由：
当入口的网络包到路由器时，他会根据一个本地的转发信息库，来决定如何正确地转发流量，这个转发信息库称为路由表
根据目的 IP 地址来配置路由：
设置 ip route add 10.176.48.0/20 via 10.173.32.1 dev eth0，就说明要去10.176.48.0/20 这个目标网络，要从 eth0 端口出去，经过 10.173.32.1。


如何配置策略路由：
除了可以根据目的 IP 地址配置路由外，还可以根据多个参数来配置路由，这称为策略路由。
可以配置多个路由表，可以根据源 IP 地址、入口设备、TO S等选择路由表，然后在路由表中查找路由。这样可以使得来自不同来源的包走不同的路由。
ip rule add from 192.168.1.0/24 table 10 
从 192.168.1.10/24 这个网段来的，使用 table 10 中的路由表
在一条路由规则中，也可以走多条路径：
ip route add default scope global nexthop via 100.100.100.1 weight 1 nexthop via 200.200.200.1 weight 2
下一跳有两个地方，权重分别为 1 2

动态路由算法
使用动态路由路由器，可以根据路由协议算法生成动态路由表，随网络运行状态的变化而变化。
无论是一个国家内部，还是国家质检，我们都可以将复杂的路径，抽象为一种叫做图的数据结构。如何在图中找到最短路径。
求最短路径的常用方法，一种是 Bellman-Ford 算法，一种是 Dijkstra 算法。
1、距离矢量路由算法 distance vector routing
基于 Bellman-Ford 算法。每个路由都保存一个路由表，包含多行，每行对应网络中的一个路由器，每行包含两部分信息，一是到目标路由器从那条线出去，另一是到目标路由器的距离。可见每个路由器都是知道全局信息的，每个路由器都知道自己和邻居之间的距离，每过几秒每个路由器都将自己所知到达所有的路由器的距离告知邻居，根据收到的信息，计算和其他路由器的距离。
第一个问题，好消息传得快，坏消息传的慢。一旦一个路由器坏了，是没有广播的，视图通过其他路径访问，直到试了所有的路径，才发现坏了。
第二个问题，每次发送的时候，要发送真个全局路由表。网络大了，受不了。
这两个问题限制了矢量路由网络规模。
2、链路状态路由算法 link state routing 基于 Dijkstra 算法
路由启动时，向邻居 say hello 邻居都回复，然后计算和邻居的距离，发送一个 echo 要求马上返回，除以二就是距离。然后将自己和邻居之间的链路状态广播发送到整个网络的每个路由器，因为每个路由器都能在自己的本地构建一个完整的图，然后针对这个图使用 Dijkstra 算法，找到两点之间的最短路径。链路状态路由协议只广播更新的或改变的网络拓扑，使得更新信息更小，节省了宽带和 CPU 利用率，一旦一个路由器坏了，它的邻居都会广播这个消息，可是坏消息迅速收敛2.



动态路由协议
1、基于链路状态路由算法的 OSPF Open Shortest Path First 开放式最短路径优先
OSPF 基于链路状态路由协议，广泛应用在数据中心的协议，由于主要用在数据中心，用于路由决策，因而称为内部网关协议 Interior Gateway Protocol IGP。
协议重点就是找到最短路径，有时 OSPF 可以发现多个最短路径，可以在这个多个路径中国进行负载均衡，常被称为等价路由，可以分摊流量、备用路线。

2、基于距离矢量路由算法的BGP
外网的路由协议，也即国家之间的，有所不同，我们称为外网路由协议 Border Gateway Protocol BGP。
国家之间不光远近的问题，还有政策的问题。对于网络包，每个数据中心都设置自己的 Policy ，那些外部 IP 可以让内部知晓，那些可以通过等等。
这一个个国家称为自制系统 AS（Autonomous System）
Stub AS：对外只有一个连接。
Multihomed AS：可能有过个连接到其他的 AS，但是大多拒绝帮其他的 AS 传输包。
Transit AS：有多个连接到其他的 AS，并且可以帮助其他的 AS 传输包。

BGP 又分为两类，eBGP 和 iBGP。
自治系统间，边界路由器之间使用 eBGP 广播路由。
内部网络也需要访问其他的自治系统。边界路由器将 BGP 学习到的路由导入到内部网络，就是通过运行 iBGP，使得内的路由器能够找到到达外网目的地的最好的边界路由器。

BGP 协议使用的算法是路径矢量路由协议 path-vector protocol，在BGP 里面，除了下一跳 hop 之外，还包括了自治系统 AS 的路径，从而可以避免坏消息传的慢的问题。

小结：
路由分静态路由和动态路由，静态路由可以配置复杂的策略路由，控制转发策略
动态路由主流算法有两种，距离矢量算法和链路状态算法。基于两种算法产生两种协议，BGP协议和 OSPF协议。



















