

### 七、ICMP 与 ping

ICMP 协议的格式：
ping 是基于 ICMP 协议工作的，Internet Control Message Protocol，互联网控制报文协议。
ICMP 报文是封装在 IP 包里，传输命令的时候，肯定需要源地址和目标地址，本身非常简单，作为侦察兵就要轻装上阵。
IP头  ICMP报文
ICMP报文：类型8位 代码8位 校验16位 数据(请求与相应:标识符16位 序号16位 数据。差错报文:unused16位 unused16位 IP头 8Byte正文)
ICMP报文有很多的类型，不同类型有不同的代码。最常用的类型是主动请求为8，主动请求的应答为0.

查询报文类型：
主动发起的对应 ICMP 的查询报文类型。常用的 ping 就是查询报文，是一种主动请求，并且获得主动应答的 ICMP 协议。ping 的主动请求称为 ICMP ECHO REQUEST。主动请求的回复称为 ICMP ECHO REPLY。比起原生的 ICMP，里面多了两个字段，一个是标识符，另一个是序号。在选项数据中 ping 还会存放发送请求的时间值，来计算往返时间

差错报文类型：
1、终点不可达 3
网络不可达代码为0，主机不可达为1，协议不可达为2，端口不可达为3，需要进行分片但设置了不分片为4
2、源抑制 4，就是让源站放慢发送速度
3、超时 11，超过网络包的生存时间还是没到
4、路由重定向 5，让下次发给另一个路由
差错报文的结构相对复杂一些，除了前面还是 IP，ICMP 的前8字节不变，后面则跟上出错的那个IP包的IP头和IP正文的前8个字节。

ping：查询报文类型的使用
![ping](https://github.com/MA806P/ComputerScienceNotes/blob/master/ComputerNetwork/Images/4-Network-Ping.jpg)
在规定的时间内，源主机没有接到 ICMP 的应打包，说明主机不可达；如果收到应答包，说明可达，源主机会检测，计算出 ICMP 数据包的时间延迟。
如在自己的可控范围之内，遇到网络不通的问题，除了直接ping目标的IP地址外，还应有一个清晰得网络拓扑图，要知道经过哪些设备，然后逐个ping中间的这些设备或机器。如果可能的话在这些关键点，通过 tcpdump -i eth0 icmp, 查看包有没有到达某个点，回复的包到达哪一个点，可以更加容易推断出错的位置。


Traceroute：差错报文类型的使用
Traceroute，是个“大骗子”。它会使用 ICMP 的规则，故意制造一些能够产生错误的场景。
所以第一个作用就是故意设置特殊的 TTL(Time To Live 生存时间)，来追踪去往目的地时沿途经过的路由器。向目的IP地址发送UDP数据包故意产生错误，数据报到达时目的主机产生错误ICMP报文，返回包从而获取到信息。
Traceroute 还有一个作用是故意设置不分片，从而确定路径的 MTU(Maximum Transmission Unit 最大传输单元。它是指一种通信协议的某一层上面所能通过的最大数据包大小,以字节为单位)，首先发送分组，设置不分片的标志，如果遇到窄的关口会被卡主，会发生ICMP网络差错包，收到ICMP不能分片差错时就减小分组的长度，直到到达目标主机。

小结：
1、ICMP相当于网络世界的侦察兵。两种类型的ICMP报文，主动侦查的查询报文，异常报告的差错报文
2、ping使用查询报文，Traceroute使用差错报文。
如果ICMP的差错报文也出问题了怎办。跨路由、跨网关的过程是怎么ping的。




### 八、出网关
怎么上网：
给每宿舍分配一个 IP 地址，这是校园网的 IP，宿舍网 IP 192.168.1.x，校园网的 IP 地址 10.10.x.x
多个电脑联网，需要配置网卡，DHCP可以默认配置的，除了配置 IP 地址，还需要配置 Gateway 网关

MAC头和IP头：
配置了IP地址和网关，就能够指定目标地址进行访问，跨网关牵扯到MAC地址和IP地址的变化
> MAC头(目的MAC地址48位 源MAC地址48位 协议类型16位-说明里面是IP协议) 
> IP头(版本4位 首部长度4位 服务类型TOS8位 总长度16位 标识16位 标志3位 片偏移13位 TTL8位 协议8位-tcp/udp 首部校验和16位 源IP地址32位 目标IP地址32位 选项)
> 数据

先判断目标IP地址和当前机器IP地址是否在同一个网段，需要CIDR和子网掩码
如果是同一网段，那就没网关什么事了，直接将源地址和目标地址放入IP头中，然后通过ARP获得MAC地址，将源MAC和目的MAC放入MAC头中，发出去就可以了
如果不是同一网段，需要发往默认网关 Gateway 它的地址和源IP地址一定是一个网段的，192.168.1/24。
将源、目标IP地址放入IP头中，通过ARP获得网关的MAC地址，将源MAC和网关的MAC放入MAC头中，发出去。网关收到包进行处理。

网关往往是一个路由器，是一个三层转发的设备。就是把MAC头和IP头都取下来，根据里面的内容，进行转发包。
路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的 IP 地址都和局域网的 IP 地址相同的网段，每只手都是它握住的那个局域网的网关。任何想发往其他局域网的包，都会到达其中一只手，拿进来取下MAC头和IP头，根据自己的路由算法，选择另一只手加上IP头和MAC头，扔出去。
选择那只手，头部要修改那些内容，问题复杂可分为两类，一是静态路由、一是动态路由

静态路由：
其实就是在路由器上，配置一条条规则。每当要选择从哪只手抛出去的时候，就一条一条的匹配规则，找到符合的规则，就按规则中设置的那样，从某个口抛出去，找下一跳 IPX

经过网关，MAC地址就必定会改变，因为已经换了局域网。
不改变 IP 地址的网关，称为转发网关；改变 IP 地址的网关，称为NAT Network Address Translation网关。
改变IP地址情况，从一个局域网发送到另一个局域网，就像出国，不能用咱们自己的身份证，而要改用护照一样。

每家都有家用路由器，家里的网段都是 192.168.1.x，所以你肯定访问不了你邻居家的这个私网的 IP 地址的。所以，当我们家里的包发出去的时候，都被家用路由器 NAT 成为了运营商的地址了。https://www.whatismyip.com/


小结：
1、离开本局域网，就需要经过网关，网关是路由器的一个网口
2、路由器是一个三层设备，里面有如何寻找下一跳的规则
3、经过路由器MAC要变，IP不变、IP要变



















