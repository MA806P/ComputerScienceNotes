

### 七、ICMP 与 ping：投石问路的侦察兵

ICMP 协议的格式：
ping 是基于 ICMP 协议工作的，Internet Control Message Protocol，互联网控制报文协议。
ICMP 报文是封装在 IP 包里，传输命令的时候，肯定需要源地址和目标地址，本身非常简单，作为侦察兵就要轻装上阵。
IP头  ICMP报文
ICMP报文：类型8位 代码8位 校验16位 数据(请求与相应:标识符16位 序号16位 数据。差错报文:unused16位 unused16位 IP头 8Byte正文)
ICMP报文有很多的类型，不同类型有不同的代码。最常用的类型是主动请求为8，主动请求的应答为0.

查询报文类型：
主动发起的对应 ICMP 的查询报文类型。常用的 ping 就是查询报文，是一种主动请求，并且获得主动应答的 ICMP 协议。ping 的主动请求称为 ICMP ECHO REQUEST。主动请求的回复称为 ICMP ECHO REPLY。比起原生的 ICMP，里面多了两个字段，一个是标识符，另一个是序号。在选项数据中 ping 还会存放发送请求的时间值，来计算往返时间

差错报文类型：
1、终点不可达 3
网络不可达代码为0，主机不可达为1，协议不可达为2，端口不可达为3，需要进行分片但设置了不分片为4
2、源抑制 4，就是让源站放慢发送速度
3、超时 11，超过网络包的生存时间还是没到
4、路由重定向 5，让下次发给另一个路由
差错报文的结构相对复杂一些，除了前面还是 IP，ICMP 的前8字节不变，后面则跟上出错的那个IP包的IP头和IP正文的前8个字节。

ping：查询报文类型的使用
![ping](https://github.com/MA806P/ComputerScienceNotes/blob/master/ComputerNetwork/Images/4-Network-Ping.jpg)
在规定的时间内，源主机没有接到 ICMP 的应打包，说明主机不可达；如果收到应答包，说明可达，源主机会检测，计算出 ICMP 数据包的时间延迟。
如在自己的可控范围之内，遇到网络不通的问题，除了直接ping目标的IP地址外，还应有一个清晰得网络拓扑图，要知道经过哪些设备，然后逐个ping中间的这些设备或机器。如果可能的话在这些关键点，通过 tcpdump -i eth0 icmp, 查看包有没有到达某个点，回复的包到达哪一个点，可以更加容易推断出错的位置。


Traceroute：差错报文类型的使用
Traceroute，是个“大骗子”。它会使用 ICMP 的规则，故意制造一些能够产生错误的场景。
所以第一个作用就是故意设置特殊的 TTL(Time To Live 生存时间)，来追踪去往目的地时沿途经过的路由器。向目的IP地址发送UDP数据包故意产生错误，数据报到达时目的主机产生错误ICMP报文，返回包从而获取到信息。
Traceroute 还有一个作用是故意设置不分片，从而确定路径的 MTU(Maximum Transmission Unit 最大传输单元。它是指一种通信协议的某一层上面所能通过的最大数据包大小,以字节为单位)，首先发送分组，设置不分片的标志，如果遇到窄的关口会被卡主，会发生ICMP网络差错包，收到ICMP不能分片差错时就减小分组的长度，直到到达目标主机。

小结：
1、ICMP相当于网络世界的侦察兵。两种类型的ICMP报文，主动侦查的查询报文，异常报告的差错报文
2、ping使用查询报文，Traceroute使用差错报文。
如果ICMP的差错报文也出问题了怎办。跨路由、跨网关的过程是怎么ping的。




